# Terraform Provider testing workflow.
name: Tests

# This GitHub action runs your tests for each pull request and push.
# Optionally, you can turn it on using a schedule for regular testing.
on:
  pull_request:
    paths-ignore:
      - 'README.md'
  push:
    paths-ignore:
      - 'README.md'

# Testing only needs permissions to read the repository contents.
permissions:
  contents: read

jobs:
  # Ensure project builds before running testing matrix
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5.4.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - run: go build -v .
      - name: Run linters
        uses: golangci/golangci-lint-action@1481404843c368bc19ca9406f87d6e0fc97bdcfd # v7.0.0
        with:
          version: latest

  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5.4.0
        with:
          go-version-file: 'go.mod'
          cache: true
      # We need the latest version of Terraform for our documentation generation to use
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false
      - run: make generate
      - name: git diff
        run: |
          git diff --compact-summary --exit-code || \
            (echo; echo "Unexpected difference in directories after code generation. Run 'make generate' command and commit."; exit 1)

  # Run unit tests (no acceptance tests, these run without Uptime Kuma)
  unit-test:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5.4.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - name: Run unit tests
        run: go test -v -cover ./internal/...
        timeout-minutes: 5

  # Run acceptance tests with Uptime Kuma running in Docker
  acceptance-test:
    name: Acceptance Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        terraform:
          - '1.4.*'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5.4.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Start Uptime Kuma services
        run: docker compose up -d

      - name: Wait for Uptime Kuma to be ready
        run: |
          echo "Waiting for Uptime Kuma to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3001 > /dev/null; then
              echo "Uptime Kuma is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done

      - name: Install Playwright
        working-directory: scripts
        run: |
          npm install
          npx playwright install chromium

      - name: Setup Uptime Kuma admin account
        working-directory: scripts
        env:
          UPTIME_KUMA_URL: http://localhost:3001
          UPTIME_KUMA_ADMIN_USERNAME: admin
          UPTIME_KUMA_ADMIN_PASSWORD: admin123
        run: node setup-uptime-kuma.js

      - name: Wait for API adapter to connect
        run: |
          echo "Waiting for API adapter to connect..."
          for i in {1..30}; do
            # Check if API is responding
            if curl -s http://localhost:8000/docs > /dev/null; then
              echo "API adapter is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done
          # Give it more time to fully connect and stabilize
          sleep 10

      - name: Verify API authentication
        run: |
          echo "Testing API authentication..."
          for i in {1..5}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8000/login/access-token \
              -d "username=admin&password=admin123")
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "API authentication successful!"
              exit 0
            fi
            echo "Attempt $i/5 - HTTP $HTTP_CODE, retrying..."
            sleep 5
          done
          echo "API authentication failed after 5 attempts"
          exit 1

      - name: Show Docker logs
        if: always()
        run: |
          echo "=== Uptime Kuma logs ==="
          docker logs uptime-kuma 2>&1 | tail -50
          echo ""
          echo "=== API adapter logs ==="
          docker logs uptime-kuma-api 2>&1 | tail -50

      - run: go mod download

      - name: Run acceptance tests
        env:
          TF_ACC: "1"
          UPTIMEKUMA_BASE_URL: "http://localhost:8000"
          UPTIMEKUMA_USERNAME: "admin"
          UPTIMEKUMA_PASSWORD: "admin123"
        # Use -p 1 to run tests sequentially and avoid rate limiting
        run: go test -v -cover -p 1 -parallel 1 ./internal/provider/
        timeout-minutes: 10

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "=== Uptime Kuma logs ==="
          docker logs uptime-kuma 2>&1
          echo ""
          echo "=== API adapter logs ==="
          docker logs uptime-kuma-api 2>&1

      - name: Cleanup
        if: always()
        run: docker compose down -v
